name: Deploy to ECS (Fargate)

on:
  push:
    branches: [ "main" ]

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: ap-northeast-1
  ECR_REPOSITORY: testapp-dev-nginx
  ECS_CLUSTER: testapp-dev-cluster
  ECS_SERVICE: testapp-dev-service
  ECS_TASK_FAMILY: testapp-dev-task
  CONTAINER_NAME: app
  CONTAINER_PORT: 80

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # OIDC 認証（Secrets に ARN を保存）
      - name: Configure AWS Credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      # ECR ログイン
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      # Docker Build
      - name: Build Docker Image
        run: |
          docker build -t $ECR_REPOSITORY .

      # Docker Tag
      - name: Tag Docker Image
        run: |
          docker tag $ECR_REPOSITORY:latest \
            ${{ steps.login-ecr.outputs.registry }}/$ECR_REPOSITORY:latest

      # ECR Push
      - name: Push to Amazon ECR
        run: |
          docker push \
            ${{ steps.login-ecr.outputs.registry }}/$ECR_REPOSITORY:latest

      # タスク定義 JSON 動的生成
      - name: Generate New Task Definition
        run: |
          IMAGE_URI="${{ steps.login-ecr.outputs.registry }}/${ECR_REPOSITORY}:latest"

          jq -n \
            --arg IMAGE "$IMAGE_URI" \
            --arg FAMILY "$ECS_TASK_FAMILY" \
            --arg EXEC_ROLE "${{ secrets.ECS_EXECUTION_ROLE_ARN }}" \
            --arg TASK_ROLE "${{ secrets.ECS_TASK_ROLE_ARN }}" \
            --arg REGION "$AWS_REGION" \
            --arg CONTAINER "$CONTAINER_NAME" \
            --argjson PORT $CONTAINER_PORT \
            '{
              family: $FAMILY,
              networkMode: "awsvpc",
              requiresCompatibilities: ["FARGATE"],
              cpu: "256",
              memory: "512",
              executionRoleArn: $EXEC_ROLE,
              taskRoleArn: $TASK_ROLE,
              containerDefinitions: [
                {
                  name: $CONTAINER,
                  image: $IMAGE,
                  essential: true,
                  portMappings: [
                    {
                      containerPort: PORT,
                      hostPort: PORT,
                      protocol: "tcp"
                    }
                  ],
                  logConfiguration: {
                    logDriver: "awslogs",
                    options: {
                      "awslogs-create-group": "true",
                      "awslogs-group": "/ecs/testapp-dev",
                      "awslogs-region": $REGION,
                      "awslogs-stream-prefix": "ecs"
                    }
                  }
                }
              ]
            }' > new-task-def.json

      # タスク定義登録
      - name: Register Task Definition to ECS
        run: |
          aws ecs register-task-definition \
            --cli-input-json file://new-task-def.json

      # ECS サービス更新
      - name: Update ECS Service
        run: |
          aws ecs update-service \
            --cluster $ECS_CLUSTER \
            --service $ECS_SERVICE \
            --force-new-deployment
